<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MTG Mobile Final</title>
    <style>
        :root { --bg: #121212; --card-bg: #2a2a2e; --text: #e0e0e0; --accent: #3a7bd5; --danger: #ff4444; --win: #00ff88; --header-h: 44px; --footer-h: 150px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* THE CRITICAL FIX: Position Fixed prevents the bounce/overflow issues */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg); color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif;
            position: fixed; 
        }

        #app-wrapper {
            display: flex; flex-direction: column;
            width: 100%; height: 100%;
        }

        #header { 
            height: var(--header-h); background: #000; display: flex; align-items: center; 
            justify-content: space-around; border-bottom: 2px solid var(--accent); font-size: 10px; font-weight: bold; flex-shrink: 0;
        }
        .phase-dot { opacity: 0.3; transition: 0.3s; }
        .phase-dot.active { opacity: 1; color: #00d4ff; border-bottom: 2px solid #00d4ff; }

        /* SCROLLABLE AREA: Middle section takes all remaining space */
        #main-scroller { 
            flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch;
            padding: 10px; display: flex; flex-direction: column; gap: 5px;
        }

        #footer { 
            height: var(--footer-h); background: #1a1a1a; border-top: 1px solid #444; 
            flex-shrink: 0; display: flex; flex-direction: column;
        }

        /* Zones */
        .zone { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; min-height: 110px; align-items: center; }
        .label { font-size: 10px; color: #777; text-transform: uppercase; margin-top: 10px; font-weight: bold; }
        
        .card { 
            width: 78px; height: 110px; background: var(--card-bg); border: 2px solid #555; border-radius: 6px; 
            flex-shrink: 0; display: flex; flex-direction: column; padding: 5px; font-size: 9px; position: relative;
        }
        .card.tapped { transform: rotate(5deg) translateY(4px); opacity: 0.6; filter: grayscale(0.5); }
        .card.attacking { border-color: #ffaa00; box-shadow: 0 0 8px #ffaa00; }
        .card.blocking { border-color: var(--win); box-shadow: 0 0 8px var(--win); transform: translateY(-5px); }
        .card.land-card { background: #1e2b1e; border-color: #3e5b3e; }

        .card-header { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .card-stats { position: absolute; bottom: 3px; right: 5px; font-weight: bold; background: #000; padding: 1px 3px; border-radius: 2px; }

        /* Log & Controls */
        #log { flex: 1; font-size: 11px; padding: 8px; background: #000; color: #4af; overflow-y: auto; line-height: 1.3; border-bottom: 1px solid #333; }
        .stats-bar { display: flex; justify-content: space-between; padding: 5px 15px; font-size: 12px; font-weight: bold; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px; }
        button { padding: 12px; border: none; border-radius: 6px; background: var(--accent); color: white; font-weight: bold; font-size: 13px; }
        button:disabled { background: #333; color: #666; }
        #btn-next { background: #28a745; }

        #overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
            z-index: 9999; flex-direction: column; align-items: center; justify-content: center; 
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1 id="win-text">YOU WIN</h1>
    <button onclick="location.reload()">Play Again</button>
</div>

<div id="app-wrapper">
    <div id="header">
        <span id="p-0" class="phase-dot">MAIN 1</span>
        <span id="p-1" class="phase-dot">ATTACK</span>
        <span id="p-2" class="phase-dot">BLOCK</span>
        <span id="p-3" class="phase-dot">MAIN 2</span>
    </div>

    <div id="main-scroller">
        <div class="label">AI HP: <span id="ai-hp" style="color:var(--danger)">20</span></div>
        <div class="zone" id="ai-field"></div>
        
        <div class="label">YOU HP: <span id="p-hp" style="color:var(--win)">20</span></div>
        <div class="zone" id="player-field"></div>
        
        <div class="label">YOUR HAND</div>
        <div class="zone" id="player-hand"></div>
        <div style="height: 20px;"></div>
    </div>

    <div id="footer">
        <div id="log">Game Loading...</div>
        <div class="stats-bar">
            <span>MANA: <b id="p-mana">0</b></span>
            <span>AI HAND: <b id="ai-count">0</b></span>
        </div>
        <div class="btn-group">
            <button id="btn-land" onclick="playLand()">Land</button>
            <button id="btn-next" onclick="nextPhase()">Next Phase</button>
        </div>
    </div>
</div>

<script>
// --- Data ---
const DB = [
    { name: "Forest", type: "land", cost: 0, p: 0, t: 0, desc: "{T}: +1" },
    { name: "Elf", type: "creature", cost: 1, p: 1, t: 1, desc: "Swift" },
    { name: "Warrior", type: "creature", cost: 2, p: 2, t: 2, desc: "Strong" },
    { name: "Beast", type: "creature", cost: 4, p: 4, t: 4, desc: "Giant" }
];

let s = {
    p_hp: 20, p_hand: [], p_field: [], p_mana: 0, p_landPlayed: false,
    ai_hp: 20, ai_hand: [], ai_field: [],
    phase: 0, isAI: false, attackers: [], blockers: []
};

function init() {
    for(let i=0; i<7; i++) {
        s.p_hand.push({...DB[Math.floor(Math.random()*3)], id: Math.random()});
        s.ai_hand.push({...DB[Math.floor(Math.random()*3)], id: Math.random()});
    }
    // Boost AI so it's a threat
    s.ai_field.push({...DB[1], id: Math.random(), sick: false});
    msg("Welcome. Tap a Forest for mana, then play a creature.");
    render();
}

function render() {
    document.getElementById('p-hp').innerText = s.p_hp;
    document.getElementById('ai-hp').innerText = s.ai_hp;
    document.getElementById('p-mana').innerText = s.p_mana;
    document.getElementById('ai-count').innerText = s.ai_hand.length;

    document.querySelectorAll('.phase-dot').forEach((el, i) => {
        el.className = (i === s.phase) ? "phase-dot active" : "phase-dot";
    });

    draw('player-hand', s.p_hand, 'hand');
    draw('player-field', s.p_field, 'field');
    draw('ai-field', s.ai_field, 'ai');

    document.getElementById('btn-land').disabled = s.p_landPlayed || s.phase !== 0 || s.isAI;
    let b = document.getElementById('btn-next');
    b.disabled = (s.isAI && s.phase !== 2);
    b.innerText = (s.isAI && s.phase === 2) ? "Confirm Blocks" : (s.phase === 3 ? "End Turn" : "Next Phase");

    if (s.p_hp <= 0 || s.ai_hp <= 0) {
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('win-text').innerText = s.p_hp <= 0 ? "DEFEAT" : "VICTORY";
    }
}

function draw(id, cards, type) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    cards.forEach(c => {
        const div = document.createElement('div');
        const atk = s.attackers.includes(c.id);
        const blk = s.blockers.includes(c.id);
        div.className = `card ${c.type==='land'?'land-card':''} ${c.tapped?'tapped':''} ${atk?'attacking':''} ${blk?'blocking':''}`;
        div.innerHTML = `<div class="card-header"><span>${c.name}</span><span>${c.type==='creature'?c.cost:''}</span></div>
                         <div style="font-size:8px; margin-top:4px; color:#aaa">${c.desc}</div>
                         ${c.type==='creature'?`<div class="card-stats">${c.p}/${c.t}</div>`:''}`;
        div.onclick = () => handle(c, type);
        el.appendChild(div);
    });
}

function handle(c, zone) {
    if (s.isAI && s.phase !== 2) return;
    if (zone === 'hand' && s.phase === 0) {
        if (c.type === 'land' && !s.p_landPlayed) {
            s.p_field.push({...c, sick: false});
            s.p_hand = s.p_hand.filter(x => x.id !== c.id);
            s.p_landPlayed = true;
        } else if (c.type === 'creature' && s.p_mana >= c.cost) {
            s.p_mana -= c.cost;
            s.p_field.push({...c, sick: true});
            s.p_hand = s.p_hand.filter(x => x.id !== c.id);
        }
    } else if (zone === 'field') {
        if (c.type === 'land' && !c.tapped) { c.tapped = true; s.p_mana++; }
        else if (c.type === 'creature' && s.phase === 1 && !c.sick && !c.tapped) {
            if (s.attackers.includes(c.id)) s.attackers = s.attackers.filter(id => id !== c.id);
            else s.attackers.push(c.id);
        } else if (c.type === 'creature' && s.phase === 2 && s.isAI && !c.tapped) {
            if (s.blockers.includes(c.id)) s.blockers = s.blockers.filter(id => id !== c.id);
            else s.blockers.push(c.id);
        }
    }
    render();
}

function msg(m) {
    const l = document.getElementById('log');
    l.innerHTML = `> ${m}<br>${l.innerHTML}`;
}

async function nextPhase() {
    if (s.phase === 1) { // Player Attack Resolve
        s.phase = 2;
        let d = 0;
        s.attackers.forEach(id => {
            let pC = s.p_field.find(x => x.id === id); pC.tapped = true;
            let aiB = s.ai_field.find(x => x.type === 'creature' && !x.tapped);
            if (aiB) {
                msg(`AI blocks with ${aiB.name}`); aiB.tapped = true;
                if (aiB.p >= pC.t) s.p_field = s.p_field.filter(x=>x.id!==pC.id);
                if (pC.p >= aiB.t) s.ai_field = s.ai_field.filter(x=>x.id!==aiB.id);
            } else { d += pC.p; }
        });
        s.ai_hp -= d; s.attackers = []; s.phase = 3;
        msg(`Dealt ${d} damage.`);
    } else if (s.isAI && s.phase === 2) { // AI Attack Resolve
        let d = 0;
        s.attackers.forEach((id, i) => {
            let aiC = s.ai_field.find(x => x.id === id);
            let bId = s.blockers[i];
            if (bId) {
                let pC = s.p_field.find(x => x.id === bId); pC.tapped = true;
                if (pC.p >= aiC.t) s.ai_field = s.ai_field.filter(x=>x.id!==aiC.id);
                if (aiC.p >= pC.t) s.p_field = s.p_field.filter(x=>x.id!==pC.id);
            } else { d += aiC.p; }
        });
        s.p_hp -= d; msg(`AI dealt ${d} damage.`);
        s.isAI = false; s.phase = 0; s.attackers = []; s.blockers = []; s.p_mana = 0; s.p_landPlayed = false;
        s.p_field.forEach(c => { c.tapped = false; c.sick = false; });
        s.p_hand.push({...DB[Math.floor(Math.random()*DB.length)], id: Math.random()});
        msg("Your Turn.");
    } else if (s.phase === 3) {
        startAI();
    } else { s.phase++; }
    render();
}

async function startAI() {
    s.isAI = true; s.phase = 0; render();
    msg("AI Thinking...");
    await new Promise(r => setTimeout(r, 600));
    s.ai_field.forEach(c => { c.tapped = false; c.sick = false; });
    s.ai_hand.push({...DB[Math.floor(Math.random()*DB.length)], id: Math.random()});
    let l = s.ai_field.filter(x=>x.type==='land').length;
    let li = s.ai_hand.findIndex(x=>x.type==='land'); if(li > -1) s.ai_field.push({...s.ai_hand.splice(li, 1)[0], sick: false});
    let ci = s.ai_hand.findIndex(x=>x.type==='creature' && x.cost <= l); if(ci > -1) s.ai_field.push({...s.ai_hand.splice(ci, 1)[0], sick: true});
    let atks = s.ai_field.filter(x => x.type==='creature' && !x.sick);
    if (atks.length > 0) {
        s.phase = 2; s.attackers = atks.map(x => x.id); atks.forEach(a => a.tapped = true);
        msg("AI Attacks! Tap your creatures to BLOCK, then Confirm.");
    } else { s.isAI = false; s.phase = 0; s.p_mana = 0; s.p_landPlayed = false; s.p_field.forEach(c => { c.tapped = false; c.sick = false; }); s.p_hand.push({...DB[Math.floor(Math.random()*DB.length)], id: Math.random()}); msg("Your Turn."); }
    render();
}

init();
</script>
</body>
</html>
