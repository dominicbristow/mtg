<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Mobile Final</title>
    <style>
        :root { --bg: #121212; --card-bg: #2a2a2e; --text: #e0e0e0; --accent: #3a7bd5; --danger: #cc0000; --header-h: 50px; --footer-h: 180px; }
        * { box-sizing: border-box; touch-action: manipulation; }
        
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; }

        /* HEADER: Fixed at top */
        #header { position: absolute; top: 0; left: 0; right: 0; height: var(--header-h); background: #000; display: flex; align-items: center; justify-content: space-around; border-bottom: 2px solid var(--accent); z-index: 100; font-size: 12px; font-weight: bold; }
        .phase-step { opacity: 0.3; }
        .phase-step.active { opacity: 1; color: #00d4ff; }

        /* MAIN SCROLL AREA: Middle section */
        #main-viewport { position: absolute; top: var(--header-h); bottom: var(--footer-h); left: 0; right: 0; overflow-y: auto; overflow-x: hidden; padding: 10px; -webkit-overflow-scrolling: touch; }
        
        /* FOOTER: Fixed at bottom */
        #footer { position: absolute; bottom: 0; left: 0; right: 0; height: var(--footer-h); background: #1a1a1a; border-top: 1px solid #444; z-index: 100; display: flex; flex-direction: column; }

        /* Card Layouts */
        .zone { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; min-height: 110px; align-items: center; }
        .label { font-size: 10px; color: #888; text-transform: uppercase; margin-top: 10px; }
        
        .card { 
            width: 80px; height: 110px; background: var(--card-bg); border: 2px solid #555; border-radius: 6px; 
            flex-shrink: 0; display: flex; flex-direction: column; padding: 5px; font-size: 10px; position: relative;
        }
        .card.tapped { transform: rotate(5deg) translateY(5px); filter: grayscale(0.8); opacity: 0.6; }
        .card.attacking { border-color: orange; box-shadow: 0 0 8px orange; }
        .card.blocking { border-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .card.dead { animation: dissolve 0.5s forwards; }
        
        .card-header { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #444; }
        .card-stats { position: absolute; bottom: 3px; right: 5px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 1px 3px; border-radius: 3px; }
        .land-card { background: #1e2b1e; }

        /* UI Controls */
        #log { flex: 1; font-size: 11px; padding: 5px 10px; background: #000; color: #0f0; overflow-y: auto; border-bottom: 1px solid #333; }
        .stats-row { display: flex; justify-content: space-between; padding: 5px 15px; font-size: 12px; }
        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px; }
        button { padding: 12px; border: none; border-radius: 5px; background: var(--accent); color: #fff; font-weight: bold; }
        button:disabled { background: #444; }

        @keyframes dissolve { from { opacity: 1; } to { opacity: 0; transform: scale(0.5); } }
    </style>
</head>
<body>

<div id="header">
    <span id="ph-0" class="phase-step">MAIN 1</span>
    <span id="ph-1" class="phase-step">ATTACK</span>
    <span id="ph-2" class="phase-step">BLOCK</span>
    <span id="ph-3" class="phase-step">MAIN 2</span>
</div>

<div id="main-viewport">
    <div class="label">AI Battlefield (HP: <span id="ai-hp">20</span>)</div>
    <div class="zone" id="ai-field"></div>
    
    <div class="label">Your Battlefield (HP: <span id="p-hp">20</span>)</div>
    <div class="zone" id="player-field"></div>
    
    <div class="label">Your Hand</div>
    <div class="zone" id="player-hand"></div>
    <div style="height: 20px;"></div>
</div>

<div id="footer">
    <div id="log">Welcome. Tap a Forest for mana, then play a creature.</div>
    <div class="stats-row">
        <span>MANA: <b id="p-mana">0</b></span>
        <span>AI HAND: <b id="ai-hand-count">7</b></span>
    </div>
    <div class="btns">
        <button id="btn-land" onclick="playLand()">Play Land</button>
        <button id="btn-next" onclick="nextPhase()">Next Phase</button>
    </div>
</div>

<script>
let state = {
    p_hp: 20, p_hand: [], p_field: [], p_mana: 0, p_landPlayed: false,
    ai_hp: 20, ai_hand: [], ai_field: [], ai_mana: 0,
    phase: 0, isAITurn: false, attackers: []
};

const DB = [
    { name: "Forest", type: "land", cost: 0, p: 0, t: 0, desc: "Tap for 1" },
    { name: "Elf", type: "creature", cost: 1, p: 1, t: 1, desc: "Fast" },
    { name: "Knight", type: "creature", cost: 2, p: 2, t: 2, desc: "Sturdy" },
    { name: "Beast", type: "creature", cost: 4, p: 4, t: 4, desc: "Huge" }
];

function createCard(proto) { return { ...proto, id: Math.random(), tapped: false, sickness: true }; }

function init() {
    for(let i=0; i<7; i++) {
        state.p_hand.push(createCard(DB[Math.floor(Math.random() * 2)]));
        state.ai_hand.push(createCard(DB[Math.floor(Math.random() * 2)]));
    }
    render();
}

function render() {
    document.getElementById('p-hp').innerText = state.p_hp;
    document.getElementById('ai-hp').innerText = state.ai_hp;
    document.getElementById('p-mana').innerText = state.p_mana;
    document.getElementById('ai-hand-count').innerText = state.ai_hand.length;

    document.querySelectorAll('.phase-step').forEach((el, i) => {
        el.className = (i === state.phase && !state.isAITurn) ? 'phase-step active' : 'phase-step';
    });

    drawZone('player-hand', state.p_hand, 'hand');
    drawZone('player-field', state.p_field, 'field');
    drawZone('ai-field', state.ai_field, 'ai');
    
    document.getElementById('btn-land').disabled = state.p_landPlayed || state.phase !== 0 || state.isAITurn;
    document.getElementById('btn-next').innerText = state.phase === 3 ? "End Turn" : "Next Phase";
}

function drawZone(id, cards, type) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    cards.forEach(c => {
        const div = document.createElement('div');
        const attacking = state.attackers.includes(c.id);
        div.className = `card ${c.type==='land'?'land-card':''} ${c.tapped?'tapped':''} ${attacking?'attacking':''}`;
        div.innerHTML = `<div class="card-header"><span>${c.name}</span><span>${c.type==='creature'?c.cost:''}</span></div>
                         <div style="font-size:8px; margin-top:5px">${c.desc}</div>
                         ${c.type==='creature'?`<div class="card-stats">${c.p}/${c.t}</div>`:''}`;
        div.onclick = () => handleClick(c, type);
        el.appendChild(div);
    });
}

function handleClick(card, zone) {
    if (state.isAITurn) return;
    if (zone === 'hand') {
        if (card.type === 'land' && !state.p_landPlayed && state.phase === 0) {
            state.p_field.push(card);
            state.p_hand = state.p_hand.filter(x => x.id !== card.id);
            state.p_landPlayed = true;
        } else if (card.type === 'creature' && state.p_mana >= card.cost && state.phase === 0) {
            state.p_mana -= card.cost;
            state.p_field.push(card);
            state.p_hand = state.p_hand.filter(x => x.id !== card.id);
        }
    } else if (zone === 'field') {
        if (card.type === 'land' && !card.tapped) {
            card.tapped = true; state.p_mana++;
        } else if (card.type === 'creature' && state.phase === 1 && !card.sickness && !card.tapped) {
            if (state.attackers.includes(card.id)) state.attackers = state.attackers.filter(x=>x!==card.id);
            else state.attackers.push(card.id);
        }
    }
    render();
}

function msg(text) {
    const l = document.getElementById('log');
    l.innerHTML = `> ${text}<br>${l.innerHTML}`;
}

async function nextPhase() {
    if (state.phase === 1) { // Resolve Combat
        state.phase = 2;
        render();
        let dmg = 0;
        state.attackers.forEach(id => {
            let c = state.p_field.find(x => x.id === id);
            c.tapped = true;
            let blocker = state.ai_field.find(x => x.type === 'creature' && !x.tapped);
            if (blocker) {
                msg(`AI blocked ${c.name} with ${blocker.name}`);
                blocker.tapped = true;
                // Simple lethal check
                if (blocker.p >= c.t) { state.p_field = state.p_field.filter(x=>x.id!==c.id); msg(`Your ${c.name} died.`); }
                if (c.p >= blocker.t) { state.ai_field = state.ai_field.filter(x=>x.id!==blocker.id); msg(`AI's ${blocker.name} died.`); }
            } else {
                dmg += c.p;
            }
        });
        state.ai_hp -= dmg;
        state.attackers = [];
        msg(`Dealt ${dmg} damage.`);
    } else if (state.phase === 3) {
        aiTurn();
    } else {
        state.phase++;
    }
    render();
}

async function aiTurn() {
    state.isAITurn = true;
    state.phase = 0;
    render();
    msg("AI Turn...");
    await new Promise(r => setTimeout(r, 600));

    // Draw & Untap
    state.ai_field.forEach(c => { c.tapped = false; c.sickness = false; });
    state.ai_hand.push(createCard(DB[Math.floor(Math.random()*DB.length)]));

    // AI Logic
    let lands = state.ai_field.filter(x=>x.type==='land').length;
    let lIdx = state.ai_hand.findIndex(x=>x.type==='land');
    if(lIdx > -1) state.ai_field.push(state.ai_hand.splice(lIdx, 1)[0]);
    
    let cIdx = state.ai_hand.findIndex(x=>x.type==='creature' && x.cost <= lands);
    if(cIdx > -1) state.ai_field.push(state.ai_hand.splice(cIdx, 1)[0]);

    // AI Attack
    let attackers = state.ai_field.filter(x=>x.type==='creature' && !x.sickness);
    let dmg = 0;
    attackers.forEach(c => {
        c.tapped = true;
        let blocker = state.p_field.find(x=>x.type==='creature' && !x.tapped);
        if(blocker) {
            msg(`You blocked ${c.name} with ${blocker.name}`);
            blocker.tapped = true;
            if (blocker.p >= c.t) state.ai_field = state.ai_field.filter(x=>x.id!==c.id);
            if (c.p >= blocker.t) state.p_field = state.p_field.filter(x=>x.id!==blocker.id);
        } else {
            dmg += c.p;
        }
    });
    state.p_hp -= dmg;
    msg(`AI deals ${dmg} damage.`);

    // End AI Turn
    state.isAITurn = false;
    state.p_landPlayed = false;
    state.p_mana = 0;
    state.p_field.forEach(c => { c.tapped = false; c.sickness = false; });
    state.p_hand.push(createCard(DB[Math.floor(Math.random()*DB.length)]));
    render();
}

init();
</script>
</body>
</html>
